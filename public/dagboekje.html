<!DOCTYPE html>

<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Home</title>
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>            
        <script>
            function switchView(view)
            {
            $.get({
                url:view,
                cache:false
            
            })
            .then(function(data){
                $("#container").html(data);
            })
            }  
        </script>
        <style>
            .slidecontainer {
              width: 100%;
            }
            
            .slider {
              -webkit-appearance: none;
              width: 100%;
              height: 25px;
              background: #d3d3d3;
              outline: none;
              opacity: 0.7;
              -webkit-transition: .2s;
              transition: opacity .2s;
            }
            
            .slider:hover {
              opacity: 1;
            }
            
            .slider::-webkit-slider-thumb {
              -webkit-appearance: none;
              appearance: none;
              width: 25px;
              height: 25px;
              background: #04AA6D;
              cursor: pointer;
            }
            
            .slider::-moz-range-thumb {
              width: 25px;
              height: 25px;
              background: #04AA6D;
              cursor: pointer;
            }
            </style>
    </head>

    <body class="h-100">

        <nav class="navbar navbar-expand-lg bg-dark text-white">
            <div class="container-fluid">
                <ul class="nav navbar-nav">
                    <li class="active">
                        <a class="navbar-brand" style="color: whitesmoke; text-decoration-style: wavy;" href="#"> 
                            Blog App
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" style="color: whitesmoke; text-decoration-style: wavy;" href="#" onclick="switchView('home.html')"> 
                            <span style="color: white">Home</span>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" style="color: whitesmoke; text-decoration-style: wavy;" href="#" onclick= "window.location.href = 'MainPage.html'"> 
                            <span style="color: white">My blogs</span>
                        </a>
                    </li>
                </ul>

                <div class="dropdown navbar-right">
                    <button id="option-id" class="btn btn-light dropdown-toggle bg-dark text-white" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Options
                    </button>

                    <div class="dropdown-menu" aria-labelledby="option-id">
                        <a class="dropdown-item" id="btn-logout" href="#">
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="row h-100 bg-light">
            <div class="col-lg-0 bg-secondary">
                <ul class="nav flex-column">

                </ul>
            </div>

            <div class="col-lg-12">
                <div class="container" id="container">
                    <!------------------------Blog Post Area BEGIN----------------------------->
                    <div class='jumbotron bg-danger' style="margin-top: 15px">
                        <script>
                            var counter=0;
                        </script>

                        <div class='container text-center'>
                            <form id="main-form" action="/dagboekje/new/" method="POST">
                                <div class="form-group">
                                    <textarea type="text" rows="5" placeholder="Description" class="form-control" id="main-desc"></textarea>
                                    <div class="invalid-feedback">
                                        Please write beke discription

                                    </div>
                                </div>
                                <div class="form-group">
                                    <input type="file" class="form-control" id="main-image">
                                    <div class="invalid-feedback">
                                        Please choose a goeie picture

                                    </div>
                                </div>
                                <div class="form-group">
                                    <img id="selected-image" width="250" height="150" src="#">

                                </div>
                                <div class = "form-group">
                                    <select name="" id="oef" class="form-control">
                                        <option value="" disabled selected>Select Oefening</option>
                                        <option value="1">oefening1</option>
                                        <option value="2">oefening2</option>
                                        <option value="3">oefening3</option>
                                    </select> 
                                    <i class="zmdi zmdi-caret-down" style="font-size: 17px;"></i>
                                </div>
                                <div class = "form-group"></div>
                                    <div class="slidecontainer">
                                        <p>Stressniveau</p>
                                        <input type="range" min="1" max="100" value="50" class="slider" id="slider">
                                        <p>Value: <span id="demo"></span></p>
                                    </div>
                                    
                                </div>
                                <!--Loading bar-->
                                <div class="form-group">
                                    <div class="progress bg-secondary">
                                        <div class="progress-bar bg-succes" id="upload-progress" style="width: 0%">
                                            0%
                                        </div>
                                    </div>
                                </div>
                                <div class="form group">
                                    <input type="checkbox" id="bevr" name="bevr" value="bevr">
                                <label for="bevr"> Bevriezen</label><br>
                                </div>
                                
                                <div class="form group">
                                    <button id="save-blog" type="button" style="width: 150px; height: 60px;" class="btn btn-light bg-light text-dark">Post</button>
                                </div>
                            </form>
                            <br>
                            <div id="result">

                            </div>
                        </div>
                    </div>
                    <!------------------------Blog Post Area END----------------------------->

                    <!------------------------After blog post area----------------------------->
                    <hr>
                    <br><br><br>
                    <div class="text-center bg-light text-dark">
                        <h3>All New Blogs</h3>
                    </div>
                    <hr>
                    <br>
                    <div class="text-center bg-light text-dark">
                        <h2>Filter By</h2>
                        <div class = "form-wrapper">
                            <select name="" id="filter" class="form-control">
                                <option value="" disabled selected>Select Oefening</option>
                                <option value="1">oefening1</option>
                                <option value="2">oefening2</option>
                                <option value="3">oefening3</option>
                            </select> 
                            <i class="zmdi zmdi-caret-down" style="font-size: 17px;"></i>
                        </div>
                    </div>
                    <br>
                    <div class="row container-fluid bg-3">
                        <div class="col-sm-12" id="stats">

                        </div>
                    </div>

                    <div class="row container-fluid bg-3">
                        <div class="col-sm-12" id="blogs">

                        </div>
                    </div>
                    <br>
                    <!------------------------After blog post area END----------------------------->

                    <!------------------------Validation and uploading of Post Blogs----------------------------->
                    
                        
                    <script type="module">


                        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
                        
                        import  { getAuth, signInWithEmailAndPassword, setPersistence, browserSessionPersistence, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js";
                        import { getDatabase,refFromURL, set, child, get, onValue, push, orderByChild } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js";
                        import { getStorage, uploadBytes, uploadBytesResumable, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-storage.js";
                        import { doc, setDoc, getFirestore, addDoc, collection, where, query, onSnapshot } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";
                        // TODO: Add SDKs for Firebase products that you want to use
                        
                        // https://firebase.google.com/docs/web/setup#available-libraries
                        
                        
                        // Your web app's Firebase configuration
                        
                        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
                        
                        const firebaseConfig = {
                
                        apiKey: "AIzaSyBO6tsIoEbbDt3uefDfmSNef9CLJZppC2E",
                        
                        authDomain: "communicatieplatform-711a9.firebaseapp.com",
                        
                        projectId: "communicatieplatform-711a9",
                        
                        storageBucket: "communicatieplatform-711a9.appspot.com",
                        
                        messagingSenderId: "188428600969",
                        
                        appId: "1:188428600969:web:fa103928e02b9de3d22858",
                        
                        measurementId: "G-HWPQ6QHN7L"
                
                        };
                        // Initialize Firebase
                         
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const dbf = getFirestore();
                        const user4 = auth.currentuser;
                        var uid = "";

                        var validImagetypes = ["image/gif", "image/jpeg", "image/png"];
                        
                        
                        
                        
                        //console.log(user4);
                        //console.log(user4.uid);
                        $("#selected-image").hide();

                        function previewImage(image_blog){
                            if(image_blog.files && image_blog.files[0])
                            {
                                
                                var reader = new FileReader();
                                console.log("preview")
                                console.log(image_blog)
                                reader.onload = function(e)
                                {
                                    $("#selected-image").attr('src', e.target.result);
                                    // fadeIn() werkt blijkbaar nie?
                                    $("#selected-image").fadeIn();
                                }
                                reader.readAsDataURL(image_blog.files[0]);
                                //$("#selected-image").show();
                            }
                        }
                        $("#main-image").change(function()
                        {
                            previewImage(this);
                        });

                        


                        //----------------------------REtrieve and dispay data from Firebase ENDS---------------------------
                        
                    

            // Import the functions you need from the SDKs you need
          
            
          
            // TODO: Add SDKs for Firebase products that you want to use
          
            // https://firebase.google.com/docs/web/setup#available-libraries
          
          
            // Your web app's Firebase configuration
          
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
          
       
          
          
      
    
    
            document.getElementById("btn-logout").addEventListener('click', function(){
            
                signOut(auth).then(() => {
                // Sign-out successful.
                console.log("suc7vol uitgelogd");
                }).catch((error) => {
                // An error happened.
                console.log(error);
                });
            
            });


                
            onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in, see docs for a list of available properties
                // https://firebase.google.com/docs/reference/js/firebase.User
                $("#save-blog").click(function()
                        {
                            var counter = 0;
                            $("#main-desc").removeClass("is-invalid");
                            $("#main-image").removeClass("is-invalid");

                            var desc = $("#main-desc").val();
                            const oef = document.getElementById("oef").value;
                            var picture = $("#main-image").prop("files")[0];
                            var bevriezenBox = document.getElementById("bevr");
                            console.log("checkBox");
                            console.log(bevriezenBox.checked);

                            if(!desc)
                            {
                                $("#main-desc").addClass("is-invalid");
                                return;
                            }

                            if(picture == null)
                            {
                                $("#main-image").addClass("is-invalid");
                                return;
                            }

                            if($.inArray(picture["type"], validImagetypes)<0)
                            {
                                $("#main-image").addClass("is-invalid");
                                return;
                            }
                            console.log("iii");
                            //--------------upload and Save to firebase storage and Firebase database------------ 
                            var db = getDatabase();
                            //var databaseref = firebase.database().ref().child("Blogs");
                            //console.log("databaseref")
                            //console.log(databaseref);
                
                            const databaseRef = refFromURL(db, 'https://communicatieplatform-711a9-default-rtdb.firebaseio.com/Dag');
                            var user = auth.currentUser;
                            let uid = user.uid;
                            const userRef = refFromURL(db, 'https://communicatieplatform-711a9-default-rtdb.firebaseio.com/users/WHAMr0YP79OkFFM6UJCTulu1KP73/' + user.uid);
                            const blogRef = refFromURL(db, 'https://communicatieplatform-711a9-default-rtdb.firebaseio.com/dagboekje/' + uid);
                            
                            onValue(databaseRef, (snapshot) => {
                                console.log("databaseRef");
                                console.log(databaseRef);
                                var name = picture["name"];
                                var dateStr = new Date().getTime();
                                var fileCompleteName= name+ "_" + dateStr;
                                //console.log(dateStr);
                                //starage
                                const storage = getStorage();
                                var storageRef = ref(storage);
                                var blogStorageRef = ref(storage, "dagboek Images/" + fileCompleteName);
                                //console.log(blogStorageRef);
                                const uploadTask = uploadBytesResumable(blogStorageRef, picture);
                                uploadTask.on('state_changed', 
                                (snapshot) => {
                                    // Observe state change events such as progress, pause, and resume
                                    // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
                                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                    //console.log('Upload is ' + progress + '% done');
                                    $('#upload-progress').html(Math.round(progress)+ "%");
                                    $('#upload-progress').attr("style", "width:" + progress + "%");
                                    switch (snapshot.state) {
                                    case 'paused':
                                        console.log('Upload is paused');
                                        break;
                                    case 'running':
                                        console.log('Upload is running');
                                        break;
                                    }
                                }, 
                                (error) => {
                                    // Handle unsuccessful uploads
                                }, 
                                () => {
                                    // Handle successful uploads on complete
                                    // For instance, get the download URL: https://firebasestorage.googleapis.com/...
                                    var username = user.username;
                                    //console.log("username");
                                    //console.log(user.uid);
                                    onValue(userRef, (snapshot) => {
                                    var fName = (snapshot.val() && snapshot.val().firstName);
                                    var sName = (snapshot.val() && snapshot.val().secondName);

                                    var userName = fName + " " + sName;
                                    });
                                    const dagboekRef = collection(dbf, "dagboekje");
                                    const q = query(dagboekRef, where("uid", "==", user.uid));
                                    const unsubscribe = onSnapshot(q, (querySnapshot) => {
                            
                                        querySnapshot.forEach((doc) => {
                                            counter = counter + 1


                                    });
                                });
                                    getDownloadURL(ref(storage, 'dagboek Images/' + fileCompleteName))
                                    .then((url) => {
                                        // `url` is the download URL for 'images/stars.jpg'
                                        var time = new Date();
                                        //console.log(url);
                                        var stressignalen = {
                                            "bevriezen": bevriezenBox.checked,
                                            "Gapen": 0,
                                            "Krabben": 0
                                        };

                                        var options =
                                        {
                                            weekday: "long",
                                            month: "long",
                                            day: "2-digit",
                                            year: "numeric"
                                        };
                                        //console.log(options)
                                        //console.log(userName)
                                        var blogData =
                                        {
                                            "image": url,
                                            "name": fileCompleteName,
                                            "desc": desc,
                                            "uid": user.uid,
                                            "counter": 5000 - counter,
                                            //"userName": userName,
                                            "time": time.toLocaleString('en-US', {hour: 'numeric', minute: 'numeric', hour12: false}),
                                            "date": time.toLocaleString('en-US', options),
                                            "timeStamp": time,
                                            "stressniveau": slider.value,
                                            "oefening": oef,
                                            "stressignalen": stressignalen
                                        };
                                        //console.log(desc);
                                        var newBlogRef = push(blogRef);
                                        //setDoc(doc(db, "dagboekje", "one"), blogData);
                                        //setDoc(doc(dbf, "dagboekje", "one"), blogData);
                                        addDoc(collection(dbf, "dagboekje"), blogData)
                                        .then( () =>{
                                            //console.log("hoooi")
                                            $("#result").attr("class", "alert alert-success");
                                            $("#result").html("blog has been upgelaad");
                                        })
                                        .catch((error) => {
                                                $("#result").attr("class", "alert alert-danger");
                                                $("#result").html(err.message);
                                                //console.log("pushding werkt helemaal nieet");
                                            // The write failed...
                                            });
                                            resetForm();
                                        
                                        //console.log("uploaded");
                                        //werkt nog nie ongeveer min 33

                                        
                                            
                                        
                                    })
                                    .catch((error) => {
                                        // Handle any errors
                                    });
                                }
                                );


                                
                            });
                            
                            
                        });
                        //--------------upload and Save to firebase storage and Firebase database END------------

                        function resetForm()
                        {
                            $("#main-form")[0].reset();
                            $("#main-form")[3].reset();
                            $("#selected-image").fadeOut();
                            $("#upload-progress").html("completed");
                            
                        
                        }
                        
                        //----------------------------REtrieve and dispay data from Firebase---------------------------
                        
                        //uid = user2.uid;
                        
                        var slider = document.getElementById("slider");
                        var output = document.getElementById("demo");
                        output.innerHTML = slider.value;

                        slider.oninput = function() {
                        output.innerHTML = this.value;
                        }
                        
                
                
            } else {
                // User is signed out
                // ...
                //window.location.href = "/signin.html";
                console.log("no usseeeerrrr")
            }
            });
                        
             
                        
                    
          </script>
                </div>
            </div>
        </div>
    </body>
</html>